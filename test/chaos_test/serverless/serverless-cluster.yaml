apiVersion: v1
kind: Secret
metadata:
  name: wesql-secret-${CLUSTER_NAME}
  namespace: ${NAMESPACE}
type: Opaque
data:
  WESQL_OBJECTSTORE_ACCESS_KEY: ${ACCESS_KEY}
  WESQL_OBJECTSTORE_SECRET_KEY: ${SECRET_KEY}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ${CLUSTER_NAME}-0
  namespace: ${NAMESPACE}
  labels:
    app.kubernetes.io/name: ${CLUSTER_NAME}-0
    app.kubernetes.io/version: ""
spec:
  serviceName: ${CLUSTER_NAME}-headless
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ${CLUSTER_NAME}-0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${CLUSTER_NAME}-0
        app.kubernetes.io/component: wesql
        app.kubernetes.io/instance: ${CLUSTER_NAME}
    spec:
      containers:
      - name: mysql
        image: ${WESQL_IMAGE}
        imagePullPolicy: IfNotPresent
        env:
        - name: WESQL_CLUSTER_MEMBER
          value: ${CLUSTER_NAME}-0-0.${CLUSTER_NAME}-headless:13306
        - name: MYSQL_ROOT_HOST
          value: '%'
        - name: MYSQL_ROOT_USER
          value: "root"
        - name: MYSQL_ROOT_PASSWORD
          value: "1234"
        - name: MYSQL_CUSTOM_CONFIG
          value: |
            [mysqld]
            port=3306
            log_error_verbosity=3
            objectstore_provider=${OBJSTORE_PROVIDER}
            objectstore-region=${OBJSTORE_REGION}
            objectstore-bucket=${OBJSTORE_BUCKET}
            objectstore-endpoint=${OBJSTORE_ENDPOINT}
            objectstore-use-https=${OBJSTORE_USE_HTTPS}
            datadir=/data/mysql/data
            log-error=/data/mysql/log/mysqld-error.log
            max_connections=2000
            performance_schema=ON
            performance_schema_show_processlist=ON
            performance_schema_accounts_size=0
            performance_schema_digests_size=0
            performance_schema_error_size=0
            performance_schema_events_stages_history_long_size=0
            performance_schema_events_stages_history_size=0
            performance_schema_events_statements_history_long_size=0
            performance_schema_events_statements_history_size=0
            performance_schema_events_transactions_history_long_size=0
            performance_schema_events_transactions_history_size=0
            performance_schema_events_waits_history_long_size=0
            performance_schema_events_waits_history_size=0
            performance_schema_hosts_size=0
            performance_schema_max_cond_classes=0
            performance_schema_max_cond_instances=0
            performance_schema_max_digest_length=0
            performance_schema_max_digest_sample_age=0
            performance_schema_max_file_classes=0
            performance_schema_max_file_handles=0
            performance_schema_max_file_instances=0
            performance_schema_max_index_stat=0
            performance_schema_max_metadata_locks=0
            performance_schema_max_mutex_classes=0
            performance_schema_max_mutex_instances=0
            performance_schema_max_prepared_statements_instances=0
            performance_schema_max_program_instances=0
            performance_schema_max_rwlock_classes=0
            performance_schema_max_rwlock_instances=0
            performance_schema_max_socket_classes=0
            performance_schema_max_socket_instances=0
            performance_schema_max_sql_text_length=0
            performance_schema_max_stage_classes=0
            performance_schema_max_statement_classes=0
            performance_schema_max_statement_stack=0
            performance_schema_max_table_handles=0
            performance_schema_max_table_instances=0
            performance_schema_max_table_lock_stat=0
            performance_schema_max_thread_classes=0
            performance_schema_max_thread_instances=0
            performance_schema_session_connect_attrs_size=0
            performance_schema_setup_actors_size=0
            performance_schema_setup_objects_size=0
            performance_schema_users_size=0
            loose_raft_replication_auto_leader_transfer=ON
            loose_raft_replication_auto_reset_match_index=ON
            loose_raft_replication_election_timeout=1000
            loose_raft_replication_heartbeat_thread_cnt=2
            loose_raft_replication_io_thread_cnt=8
            loose_raft_replication_large_trx=ON
            loose_raft_replication_prefetch_window_size=100
            loose_raft_replication_worker_thread_cnt=8
            thread_stack=262144
            thread_cache_size=60
            open_files_limit=1048576
            local_infile=ON
            persisted_globals_load=OFF
            sql_mode=NO_ENGINE_SUBSTITUTION
            table_open_cache=4000
            max_prepared_stmt_count=16382
            read_buffer_size=262144
            read_rnd_buffer_size=524288
            join_buffer_size=262144
            sort_buffer_size=262144
            log_error_verbosity=3
            log_output=FILE
            log_error=/data/mysql/log/mysqld-error.log
            slow_query_log=ON
            long_query_time=5
            slow_query_log_file=/data/mysql/log/mysqld-slowquery.log
            general_log=ON
            general_log_file=/data/mysql/log/mysqld.log
            binlog_cache_size=32768
            binlog_format=ROW
            binlog_row_image=FULL
            binlog_order_commits=ON
            log-bin=mysql-bin
            log_bin_index=mysql-bin.index
            binlog_expire_logs_seconds=604800
            max_binlog_size=134217728
            log_replica_updates=1
            binlog_transaction_dependency_tracking=WRITESET
            slave_parallel_workers=8
            loose_smartengine_datadir=/data/mysql/data/smartengine
            loose_smartengine_wal_dir=/data/mysql/data/smartengine
            loose_smartengine_flush_log_at_trx_commit=1
            loose_smartengine_enable_2pc=1
            loose_smartengine_batch_group_slot_array_size=5
            loose_smartengine_batch_group_max_group_size=15
            loose_smartengine_batch_group_max_leader_wait_time_us=50
            loose_smartengine_block_size=16384
            loose_smartengine_disable_auto_compactions=0
            loose_smartengine_dump_memtable_limit_size=0
            loose_smartengine_min_write_buffer_number_to_merge=1
            loose_smartengine_level0_file_num_compaction_trigger=64
            loose_smartengine_level0_layer_num_compaction_trigger=2
            loose_smartengine_level1_extents_major_compaction_trigger=1000
            loose_smartengine_level2_usage_percent=70
            loose_smartengine_flush_delete_percent=70
            loose_smartengine_compaction_delete_percent=50
            loose_smartengine_flush_delete_percent_trigger=700000
            loose_smartengine_flush_delete_record_trigger=700000
            loose_smartengine_scan_add_blocks_limit=100
            loose_smartengine_compression_per_level=kZSTD:kZSTD:kZSTD
            loose_smartengine_write_buffer_size=127926272
            loose_smartengine_db_write_buffer_size=3865051136
            loose_smartengine_db_total_write_buffer_size=3865051136
            loose_smartengine_block_cache_size=3865051136
            loose_smartengine_row_cache_size=1287651328
            loose_smartengine_max_total_wal_size=3865051136
            loose_smartengine_max_background_flushes=3
            loose_smartengine_base_background_compactions=3
            loose_smartengine_max_background_compactions=3
            innodb_buffer_pool_dump_at_shutdown=OFF
            skip_name_resolve=ON
            raft_replication_log_level=LOG_DEBUG
        - name: WESQL_OBJECTSTORE_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: WESQL_OBJECTSTORE_ACCESS_KEY
              name: wesql-secret-${CLUSTER_NAME}
        - name: WESQL_OBJECTSTORE_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: WESQL_OBJECTSTORE_SECRET_KEY
              name: wesql-secret-${CLUSTER_NAME}
        ports:
        - containerPort: 3306
          name: mysql
          protocol: TCP
        - containerPort: 13306
          name: paxos
          protocol: TCP
        resources:
          limits:
            cpu: "4"
            memory: 8Gi
          requests:
            cpu: "4"
            memory: 8Gi
        securityContext:
          capabilities:
            add:
            - SYS_PTRACE
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /data/mysql
          name: data
      terminationGracePeriodSeconds: 30
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 100Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ${CLUSTER_NAME}-1
  namespace: ${NAMESPACE}
  labels:
    app.kubernetes.io/name: ${CLUSTER_NAME}-1
    app.kubernetes.io/version: ""
spec:
  serviceName: ${CLUSTER_NAME}-headless
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ${CLUSTER_NAME}-1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${CLUSTER_NAME}-1
        app.kubernetes.io/component: wesql
        app.kubernetes.io/instance: ${CLUSTER_NAME}
    spec:
      containers:
      - name: mysql
        image: ${WESQL_IMAGE}
        imagePullPolicy: IfNotPresent
        env:
        - name: WESQL_CLUSTER_MEMBER
          value: ${CLUSTER_NAME}-1-0.${CLUSTER_NAME}-headless:13306
        - name: MYSQL_ROOT_HOST
          value: '%'
        - name: MYSQL_ROOT_USER
          value: "root"
        - name: MYSQL_ROOT_PASSWORD
          value: "1234"
        - name: CLUSTER_START_INDEX
          value: "1"
        - name: MYSQL_CUSTOM_CONFIG
          value: |
            [mysqld]
            port=3306
            log_error_verbosity=3
            serverless=on
            objectstore_provider=${OBJSTORE_PROVIDER}
            objectstore-region=${OBJSTORE_REGION}
            objectstore-bucket=${OBJSTORE_BUCKET}
            objectstore-endpoint=${OBJSTORE_ENDPOINT}
            objectstore-use-https=${OBJSTORE_USE_HTTPS}
            datadir=/data/mysql/data
            log-error=/data/mysql/log/mysqld-error.log
            max_connections=2000
            max_connections=100
            loose_raft_replication_io_thread_cnt=8
            loose_raft_replication_worker_thread_cnt=8
            loose_raft_replication_election_timeout=1000
            loose_raft_replication_auto_leader_transfer=ON
            loose_raft_replication_prefetch_window_size=100
            loose_raft_replication_auto_reset_match_index=ON
            loose_raft_replication_large_trx=ON
            loose_raft_replication_heartbeat_thread_cnt=2
            thread_stack=262144
            thread_cache_size=60
            persisted_globals_load=OFF
            sql_mode=NO_ENGINE_SUBSTITUTION
            performance_schema=OFF
            read_buffer_size=262144
            read_rnd_buffer_size=524288
            join_buffer_size=262144
            sort_buffer_size=262144
            log_error_verbosity=3
            log_output=FILE
            log_error=/data/mysql/log/mysqld-error.log
            slow_query_log=ON
            long_query_time=5
            slow_query_log_file=/data/mysql/log/mysqld-slowquery.log
            general_log=ON
            general_log_file=/data/mysql/log/mysqld.log
            log-bin=mysql-bin
            log_bin_index=mysql-bin.index
            binlog_expire_logs_seconds=604800
            max_binlog_size=134217728
            skip_name_resolve=ON
            raft_replication_log_level=LOG_DEBUG
            innodb_buffer_pool_dump_at_shutdown=OFF
        - name: WESQL_LOGGER_MODE
          value: "1"
        - name: WESQL_OBJECTSTORE_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: WESQL_OBJECTSTORE_ACCESS_KEY
              name: wesql-secret-${CLUSTER_NAME}
        - name: WESQL_OBJECTSTORE_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: WESQL_OBJECTSTORE_SECRET_KEY
              name: wesql-secret-${CLUSTER_NAME}
        ports:
        - containerPort: 3306
          name: mysql
          protocol: TCP
        - containerPort: 13306
          name: paxos
          protocol: TCP
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
          requests:
            cpu: "1"
            memory: 1Gi
        securityContext:
          capabilities:
            add:
            - SYS_PTRACE
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /data/mysql
          name: data
      terminationGracePeriodSeconds: 30
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 100Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ${CLUSTER_NAME}-2
  namespace: ${NAMESPACE}
  labels:
    app.kubernetes.io/name: ${CLUSTER_NAME}-2
    app.kubernetes.io/version: ""
spec:
  serviceName: ${CLUSTER_NAME}-headless
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ${CLUSTER_NAME}-2
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${CLUSTER_NAME}-2
        app.kubernetes.io/component: wesql
        app.kubernetes.io/instance: ${CLUSTER_NAME}
    spec:
      containers:
      - name: mysql
        image: ${WESQL_IMAGE}
        imagePullPolicy: IfNotPresent
        env:
        - name: WESQL_CLUSTER_MEMBER
          value: ${CLUSTER_NAME}-2-0.${CLUSTER_NAME}-headless:13306
        - name: MYSQL_ROOT_HOST
          value: '%'
        - name: MYSQL_ROOT_USER
          value: "root"
        - name: MYSQL_ROOT_PASSWORD
          value: "1234"
        - name: MYSQL_CUSTOM_CONFIG
          value: |
            [mysqld]
            port=3306
            log_error_verbosity=3
            serverless=on
            objectstore_provider=${OBJSTORE_PROVIDER}
            objectstore-region=${OBJSTORE_REGION}
            objectstore-bucket=${OBJSTORE_BUCKET}
            objectstore-endpoint=${OBJSTORE_ENDPOINT}
            objectstore-use-https=${OBJSTORE_USE_HTTPS}
            datadir=/data/mysql/data
            log-error=/data/mysql/log/mysqld-error.log
            max_connections=2000
            max_connections=100
            loose_raft_replication_io_thread_cnt=8
            loose_raft_replication_worker_thread_cnt=8
            loose_raft_replication_election_timeout=1000
            loose_raft_replication_auto_leader_transfer=ON
            loose_raft_replication_prefetch_window_size=100
            loose_raft_replication_auto_reset_match_index=ON
            loose_raft_replication_large_trx=ON
            loose_raft_replication_heartbeat_thread_cnt=2
            thread_stack=262144
            thread_cache_size=60
            persisted_globals_load=OFF
            sql_mode=NO_ENGINE_SUBSTITUTION
            performance_schema=OFF
            read_buffer_size=262144
            read_rnd_buffer_size=524288
            join_buffer_size=262144
            sort_buffer_size=262144
            log_error_verbosity=3
            log_output=FILE
            log_error=/data/mysql/log/mysqld-error.log
            slow_query_log=ON
            long_query_time=5
            slow_query_log_file=/data/mysql/log/mysqld-slowquery.log
            general_log=ON
            general_log_file=/data/mysql/log/mysqld.log
            log-bin=mysql-bin
            log_bin_index=mysql-bin.index
            binlog_expire_logs_seconds=604800
            max_binlog_size=134217728
            skip_name_resolve=ON
            loose_raft_replication_log_level=LOG_DEBUG
            innodb_buffer_pool_dump_at_shutdown=OFF
        - name: WESQL_LOGGER_MODE
          value: "1"
        - name: WESQL_OBJECTSTORE_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: WESQL_OBJECTSTORE_ACCESS_KEY
              name: wesql-secret-${CLUSTER_NAME}
        - name: WESQL_OBJECTSTORE_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: WESQL_OBJECTSTORE_SECRET_KEY
              name: wesql-secret-${CLUSTER_NAME}
        ports:
        - containerPort: 3306
          name: mysql
          protocol: TCP
        - containerPort: 13306
          name: paxos
          protocol: TCP
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
          requests:
            cpu: "1"
            memory: 1Gi
        securityContext:
          capabilities:
            add:
            - SYS_PTRACE
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /data/mysql
          name: data
      terminationGracePeriodSeconds: 30
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 100Gi

---
apiVersion: v1
kind: Service
metadata:
  annotations:
    monitor.kubeblocks.io/agamotto: "false"
    monitor.kubeblocks.io/scrape: "false"
  labels:
    app.kubernetes.io/component: wesql
    app.kubernetes.io/instance: ${CLUSTER_NAME}
  name: ${CLUSTER_NAME}-headless
  namespace: ${NAMESPACE}
spec:
  clusterIP: None
  clusterIPs:
  - None
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: mysql
    port: 3306
    protocol: TCP
    targetPort: mysql
  - name: paxos
    port: 13306
    protocol: TCP
    targetPort: paxos
  publishNotReadyAddresses: true
  selector:
    app.kubernetes.io/instance: ${CLUSTER_NAME}
    app.kubernetes.io/component: wesql
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}
