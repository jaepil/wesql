# Wait for at least 1 snapshots to be generated 
set global snapshot_archive=false;
set global snapshot_archive_innodb_tar_mode='tar';
set global snapshot_archive_smartengine_tar_mode='tar';
CREATE DATABASE db1;
CREATE TABLE t1(c1 int) ENGINE=SMARTENGINE ;
INSERT INTO t1 values(1);
INSERT INTO t1 values(2);
INSERT INTO t1 values(3);
INSERT INTO t1 values(4);
SELECT * FROM t1;
c1
1
2
3
4
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `c1` int DEFAULT NULL
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
set global snapshot_archive=true;
# Wait for at least 1 snapshots to be generated 
set global snapshot_archive=false;
set global snapshot_archive_innodb_tar_mode='tar_and_compress';
set global snapshot_archive_smartengine_tar_mode='tar_and_compress';
INSERT INTO t1 values(5);
INSERT INTO t1 values(6);
SELECT * FROM t1;
c1
1
2
3
4
5
6
set global snapshot_archive=true;
# Wait for at least 1 snapshots to be generated 
# Wait for at least 1 snapshots to be generated 
# Select SNAPSHOT_INNODB_PERSISTENT_SNAPSHOT_INDEX
SELECT IF(RIGHT(INNODB_SNAPSHOT_NAME, 1) = '/', SUBSTRING_INDEX(SUBSTRING_INDEX(INNODB_SNAPSHOT_NAME, '/', -2), '/', 1), SUBSTRING_INDEX(SUBSTRING_INDEX(INNODB_SNAPSHOT_NAME, '/', -1), '.', 1)) AS name FROM INFORMATION_SCHEMA.SNAPSHOT_INNODB_PERSISTENT_SNAPSHOT_INDEX ORDER BY name limit 3;
name
innodb_0000000002_000001
innodb_0000000002_000002
innodb_0000000002_000003
# Select SNAPSHOT_INNODB_PERSISTENT_SNAPSHOTS
SELECT IF(RIGHT(INNODB_SNAPSHOT_KEY, 1) = '/', SUBSTRING_INDEX(SUBSTRING_INDEX(INNODB_SNAPSHOT_KEY, '/', -2), '/', 1), SUBSTRING_INDEX(SUBSTRING_INDEX(INNODB_SNAPSHOT_KEY, '/', -1), '.', 1)) AS name FROM INFORMATION_SCHEMA.SNAPSHOT_INNODB_PERSISTENT_SNAPSHOTS ORDER BY name limit 3;
name
innodb_0000000002_000001
innodb_0000000002_000002
innodb_0000000002_000003
# Select SNAPSHOT_SMARTENGINE_PERSISTENT_SNAPSHOT_INDEX
SELECT IF(RIGHT(SMARTENGINE_SNAPSHOT_NAME, 1) = '/', SUBSTRING_INDEX(SUBSTRING_INDEX(SMARTENGINE_SNAPSHOT_NAME, '/', -2), '/', 1), SUBSTRING_INDEX(SUBSTRING_INDEX(SMARTENGINE_SNAPSHOT_NAME, '/', -1), '.', 1)) AS name FROM INFORMATION_SCHEMA.SNAPSHOT_SMARTENGINE_PERSISTENT_SNAPSHOT_INDEX ORDER BY name limit 3;
name
smartengine_0000000002_000001
smartengine_0000000002_000002
smartengine_0000000002_000003
# SNAPSHOT_SMARTENGINE_PERSISTENT_SNAPSHOTS
SELECT IF(RIGHT(SMARTENGINE_SNAPSHOT_KEY, 1) = '/', SUBSTRING_INDEX(SUBSTRING_INDEX(SMARTENGINE_SNAPSHOT_KEY, '/', -2), '/', 1), SUBSTRING_INDEX(SUBSTRING_INDEX(SMARTENGINE_SNAPSHOT_KEY, '/', -1), '.', 1)) AS name FROM INFORMATION_SCHEMA.SNAPSHOT_SMARTENGINE_PERSISTENT_SNAPSHOTS ORDER BY name limit 3;
name
smartengine_0000000002_000001
smartengine_0000000002_000002
smartengine_0000000002_000003
# Crash
set debug = 'd, crash_commit_before_log';
INSERT INTO t1 values(100);
ERROR HY000: Lost connection to MySQL server during query
# Force rmdir datadir for recovery test
# Recovery start from object store.
# restart
SELECT * FROM t1;
c1
1
2
3
4
5
6
DROP TABLE t1;
DROP DATABASE db1;
